# 邮箱验证问题排查指南

## 常见问题

### ❌ 问题1: QQ邮箱拦截 localhost 链接

**症状**：
```json
{
  "head": {
    "ret": -5002,
    "cgi": "xmspamchecklogicsvr/xmsafejump",
    "time": 1760427359,
    "msg": "",
    "stack": "Invalid url"
  }
}
```

**原因**：
- **QQ 邮箱的安全机制**会检查邮件中的链接
- `localhost` 被 QQ 邮箱认为是不安全的 URL
- QQ 邮箱会通过 `wx.mail.qq.com/xmspamcheck` 检查链接，但拒绝 localhost

**这不是代码问题！** 这是 QQ 邮箱的安全限制。

**解决方案**：

**方案 1：从控制台复制链接（最简单）**

1. 查看服务器控制台输出：
   ```
   ================================================================================
   📧 邮箱验证邮件
   收件人: your@email.com
   验证链接: http://localhost:3000/api/auth/verify-email?token=xxx
   提示: 如果QQ邮箱拦截localhost链接，请直接复制上面的链接到浏览器
   ================================================================================
   ```

2. **直接复制验证链接到浏览器地址栏**，绕过 QQ 邮箱检查

**方案 2：使用其他邮箱测试（推荐）**

QQ 邮箱对 localhost 限制严格，换用其他邮箱：
- ✅ **Gmail** - 不拦截 localhost
- ✅ **Outlook/Hotmail** - 不拦截 localhost  
- ✅ **163 邮箱** - 通常不拦截
- ❌ **QQ 邮箱** - 拦截 localhost（不推荐开发测试）

**方案 3：使用 ngrok 获取公网域名（最佳开发方案）**

```bash
# 1. 安装 ngrok
npm install -g ngrok

# 2. 启动 ngrok
ngrok http 3000

# 3. 复制 ngrok 提供的 HTTPS URL
# 例如: https://abc123.ngrok.io

# 4. 更新 .env
NEXT_PUBLIC_BASE_URL=https://abc123.ngrok.io

# 5. 重启服务器
npm run dev
```

这样 QQ 邮箱就能识别 HTTPS 链接了！

**方案 4：手动从 QQ 邮箱 URL 提取链接**

QQ 邮箱的跳转 URL 格式：
```
https://wx.mail.qq.com/xmspamcheck/xmsafejump?url=http%3A%2F%2Flocalhost%3A3000%2F...
```

提取 `url` 参数并 URL 解码：
```javascript
// 使用浏览器控制台
decodeURIComponent("http%3A%2F%2Flocalhost%3A3000%2Fapi%2Fauth%2Fverify-email%3Ftoken%3Dxxx")
// 结果: http://localhost:3000/api/auth/verify-email?token=xxx
```

然后直接访问解码后的链接。

---

### ❌ 问题2: 收不到验证邮件

**排查步骤**：

1. **检查 Resend API Key**
   ```bash
   # 查看 .env 文件
   cat .env | grep RESEND_API_KEY
   ```
   - 确保 API Key 正确
   - 确保没有多余的空格或引号

2. **检查发件人邮箱**
   ```bash
   cat .env | grep EMAIL_FROM
   ```
   - 开发环境可用 `onboarding@resend.dev`
   - 生产环境必须是已验证的域名邮箱

3. **查看服务器日志**
   ```bash
   # 查看控制台输出
   # 应该看到：
   # Email sent successfully: { id: 'xxx', ... }
   
   # 如果看到错误：
   # Error sending email: { ... }
   ```

4. **检查垃圾邮件箱**
   - 查看垃圾邮件/spam 文件夹
   - 将发件人添加到白名单

5. **Resend 控制台检查**
   - 登录 [Resend Dashboard](https://resend.com/emails)
   - 查看 "Emails" 页面的发送记录
   - 检查邮件状态（delivered/bounced/failed）

---

### ❌ 问题3: 验证链接过期

**症状**：点击验证链接显示 "链接已过期"

**原因**：
- 验证链接默认 24 小时有效期
- Token 已被使用或删除

**解决方案**：

1. **重新发送验证邮件**
   - 尝试登录
   - 看到"邮箱未验证"提示
   - 点击"重新发送验证邮件"

2. **调整过期时间（如需要）**
   
   在 `src/lib/auth.ts` 中：
   ```typescript
   emailVerification: {
     sendOnSignUp: true,
     expiresIn: 60 * 60 * 24 * 3, // 3天（默认是24小时）
     // ... 其他配置
   }
   ```

---

### ❌ 问题4: 验证成功但没有自动登录

**检查配置**：

```typescript
// src/lib/auth.ts
emailVerification: {
  sendOnSignUp: true,
  autoSignInAfterVerification: true, // ← 确保为 true
  // ...
}
```

**如果仍不工作**：
1. 清除浏览器 cookies
2. 检查 `BETTER_AUTH_SECRET` 是否正确配置
3. 重启服务器

---

### ❌ 问题5: 开发环境测试问题

**Resend 免费版限制**：
- 使用 `onboarding@resend.dev` 发送
- 只能发送到注册 Resend 时使用的邮箱

**解决方案**：

**选项 1：使用注册邮箱测试**
```env
EMAIL_FROM=onboarding@resend.dev
```
注册时使用你在 Resend 注册的邮箱

**选项 2：验证自己的域名**
1. 在 Resend 添加域名
2. 配置 DNS 记录
3. 验证通过后使用域名邮箱

**选项 3：控制台输出（调试）**

临时添加日志输出验证链接：
```typescript
// src/lib/auth.ts
sendVerificationEmail: async ({ user, url }, request) => {
  console.log('📧 验证链接:', url); // 添加这行
  await sendEmail({
    to: user.email,
    subject: "验证你的 Dreamifly 邮箱",
    html: createVerificationEmailHTML(url, user.name),
  });
},
```

然后在控制台复制链接直接访问。

---

## 完整检查清单

### 环境变量检查

```bash
# 检查所有必需的环境变量
cat .env
```

必需的变量：
- ✅ `DATABASE_URL` - 数据库连接
- ✅ `NEXT_PUBLIC_BASE_URL` - 应用基础 URL
- ✅ `BETTER_AUTH_SECRET` - 认证密钥
- ✅ `RESEND_API_KEY` - Resend API Key
- ✅ `EMAIL_FROM` - 发件人邮箱

### 代码配置检查

1. **src/lib/auth.ts**
   - ✅ 添加 `baseURL` 配置
   - ✅ `requireEmailVerification: true`
   - ✅ `sendOnSignUp: true`
   - ✅ `autoSignInAfterVerification: true`

2. **src/lib/email.ts**
   - ✅ Resend 初始化正确
   - ✅ `sendEmail` 函数正常工作

3. **src/app/[locale]/verify-email/page.tsx**
   - ✅ 验证页面存在
   - ✅ Token 处理逻辑正确

### 网络检查

```bash
# 检查能否访问 Resend API
curl -X POST https://api.resend.com/emails \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json"
```

### 数据库检查

```sql
-- 检查 verification 表
SELECT * FROM verification ORDER BY created_at DESC LIMIT 5;

-- 检查用户邮箱验证状态
SELECT id, email, email_verified FROM "user" ORDER BY created_at DESC LIMIT 5;
```

---

## 调试技巧

### 1. 启用详细日志

在 `src/lib/email.ts` 中添加更多日志：

```typescript
export async function sendEmail({ to, subject, html }: SendEmailParams) {
  console.log('📧 准备发送邮件');
  console.log('📧 收件人:', to);
  console.log('📧 主题:', subject);
  
  try {
    const { data, error } = await resend.emails.send({
      from: process.env.EMAIL_FROM || 'Dreamifly <noreply@dreamifly.com>',
      to: [to],
      subject,
      html,
    });

    if (error) {
      console.error('❌ 邮件发送失败:', error);
      throw new Error('Failed to send email');
    }

    console.log('✅ 邮件发送成功:', data);
    return data;
  } catch (error) {
    console.error('❌ 发送过程出错:', error);
    throw error;
  }
}
```

### 2. 临时禁用邮箱验证

如果需要快速测试其他功能：

```typescript
// src/lib/auth.ts
emailAndPassword: {
  enabled: true,
  requireEmailVerification: false, // 临时禁用
  autoSignIn: true, // 注册后自动登录
}
```

### 3. 查看邮件 HTML

保存邮件 HTML 到文件查看：

```typescript
// 临时代码
import fs from 'fs';

const html = createVerificationEmailHTML(url, user.name);
fs.writeFileSync('email-preview.html', html);
```

然后在浏览器打开 `email-preview.html` 查看效果。

---

## 测试流程

### 完整测试步骤

1. **准备工作**
   ```bash
   # 确保所有环境变量正确
   cat .env
   
   # 重启服务器
   npm run dev
   ```

2. **注册测试**
   - 打开浏览器访问网站
   - 点击"注册"
   - 填写信息（使用 Resend 注册的邮箱）
   - 提交注册

3. **检查邮件**
   - 查看控制台日志
   - 查看邮箱（包括垃圾邮件）
   - 查看 Resend 控制台

4. **验证测试**
   - 点击邮件中的验证链接
   - 检查是否跳转到验证页面
   - 检查是否显示"验证成功"
   - 检查是否自动登录

5. **登录测试**
   - 登出
   - 尝试登录
   - 应该成功登录

---

## 生产环境部署

### 必做配置

1. **配置自己的域名邮箱**
   ```env
   EMAIL_FROM=noreply@yourdomain.com
   ```

2. **设置正确的 BASE_URL**
   ```env
   NEXT_PUBLIC_BASE_URL=https://yourdomain.com
   ```

3. **使用强密钥**
   ```bash
   openssl rand -base64 32
   ```

4. **DNS 配置**
   - SPF 记录
   - DKIM 记录  
   - DMARC 记录

5. **监控设置**
   - 邮件发送成功率
   - 验证成功率
   - 错误告警

---

## 获取帮助

如果以上方法都无法解决问题：

1. **查看控制台完整错误日志**
2. **检查 Resend 控制台的详细错误**
3. **查看 Better Auth 官方文档**：
   - [Email Verification](https://www.better-auth.com/docs/authentication/email-password#email-verification)
4. **检查项目 Issues**
5. **联系技术支持**

---

## 快速修复命令

```bash
# 1. 确保环境变量正确
cp env.example .env
# 编辑 .env 填入正确的值

# 2. 重新安装依赖
npm install

# 3. 重新生成数据库
npx drizzle-kit push

# 4. 重启服务器
npm run dev

# 5. 清除浏览器缓存和 cookies
# 在浏览器中手动操作
```

---

**记住**：遇到问题时，最重要的是查看控制台日志和 Resend 控制台，那里会有详细的错误信息！

