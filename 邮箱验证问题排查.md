# é‚®ç®±éªŒè¯é—®é¢˜æ’æŸ¥æŒ‡å—

## å¸¸è§é—®é¢˜

### âŒ é—®é¢˜1: QQé‚®ç®±æ‹¦æˆª localhost é“¾æ¥

**ç—‡çŠ¶**ï¼š
```json
{
  "head": {
    "ret": -5002,
    "cgi": "xmspamchecklogicsvr/xmsafejump",
    "time": 1760427359,
    "msg": "",
    "stack": "Invalid url"
  }
}
```

**åŸå› **ï¼š
- **QQ é‚®ç®±çš„å®‰å…¨æœºåˆ¶**ä¼šæ£€æŸ¥é‚®ä»¶ä¸­çš„é“¾æ¥
- `localhost` è¢« QQ é‚®ç®±è®¤ä¸ºæ˜¯ä¸å®‰å…¨çš„ URL
- QQ é‚®ç®±ä¼šé€šè¿‡ `wx.mail.qq.com/xmspamcheck` æ£€æŸ¥é“¾æ¥ï¼Œä½†æ‹’ç» localhost

**è¿™ä¸æ˜¯ä»£ç é—®é¢˜ï¼** è¿™æ˜¯ QQ é‚®ç®±çš„å®‰å…¨é™åˆ¶ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

**æ–¹æ¡ˆ 1ï¼šä»æ§åˆ¶å°å¤åˆ¶é“¾æ¥ï¼ˆæœ€ç®€å•ï¼‰**

1. æŸ¥çœ‹æœåŠ¡å™¨æ§åˆ¶å°è¾“å‡ºï¼š
   ```
   ================================================================================
   ğŸ“§ é‚®ç®±éªŒè¯é‚®ä»¶
   æ”¶ä»¶äºº: your@email.com
   éªŒè¯é“¾æ¥: http://localhost:3000/api/auth/verify-email?token=xxx
   æç¤º: å¦‚æœQQé‚®ç®±æ‹¦æˆªlocalhosté“¾æ¥ï¼Œè¯·ç›´æ¥å¤åˆ¶ä¸Šé¢çš„é“¾æ¥åˆ°æµè§ˆå™¨
   ================================================================================
   ```

2. **ç›´æ¥å¤åˆ¶éªŒè¯é“¾æ¥åˆ°æµè§ˆå™¨åœ°å€æ **ï¼Œç»•è¿‡ QQ é‚®ç®±æ£€æŸ¥

**æ–¹æ¡ˆ 2ï¼šä½¿ç”¨å…¶ä»–é‚®ç®±æµ‹è¯•ï¼ˆæ¨èï¼‰**

QQ é‚®ç®±å¯¹ localhost é™åˆ¶ä¸¥æ ¼ï¼Œæ¢ç”¨å…¶ä»–é‚®ç®±ï¼š
- âœ… **Gmail** - ä¸æ‹¦æˆª localhost
- âœ… **Outlook/Hotmail** - ä¸æ‹¦æˆª localhost  
- âœ… **163 é‚®ç®±** - é€šå¸¸ä¸æ‹¦æˆª
- âŒ **QQ é‚®ç®±** - æ‹¦æˆª localhostï¼ˆä¸æ¨èå¼€å‘æµ‹è¯•ï¼‰

**æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ ngrok è·å–å…¬ç½‘åŸŸåï¼ˆæœ€ä½³å¼€å‘æ–¹æ¡ˆï¼‰**

```bash
# 1. å®‰è£… ngrok
npm install -g ngrok

# 2. å¯åŠ¨ ngrok
ngrok http 3000

# 3. å¤åˆ¶ ngrok æä¾›çš„ HTTPS URL
# ä¾‹å¦‚: https://abc123.ngrok.io

# 4. æ›´æ–° .env
NEXT_PUBLIC_BASE_URL=https://abc123.ngrok.io

# 5. é‡å¯æœåŠ¡å™¨
npm run dev
```

è¿™æ · QQ é‚®ç®±å°±èƒ½è¯†åˆ« HTTPS é“¾æ¥äº†ï¼

**æ–¹æ¡ˆ 4ï¼šæ‰‹åŠ¨ä» QQ é‚®ç®± URL æå–é“¾æ¥**

QQ é‚®ç®±çš„è·³è½¬ URL æ ¼å¼ï¼š
```
https://wx.mail.qq.com/xmspamcheck/xmsafejump?url=http%3A%2F%2Flocalhost%3A3000%2F...
```

æå– `url` å‚æ•°å¹¶ URL è§£ç ï¼š
```javascript
// ä½¿ç”¨æµè§ˆå™¨æ§åˆ¶å°
decodeURIComponent("http%3A%2F%2Flocalhost%3A3000%2Fapi%2Fauth%2Fverify-email%3Ftoken%3Dxxx")
// ç»“æœ: http://localhost:3000/api/auth/verify-email?token=xxx
```

ç„¶åç›´æ¥è®¿é—®è§£ç åçš„é“¾æ¥ã€‚

---

### âŒ é—®é¢˜2: æ”¶ä¸åˆ°éªŒè¯é‚®ä»¶

**æ’æŸ¥æ­¥éª¤**ï¼š

1. **æ£€æŸ¥ Resend API Key**
   ```bash
   # æŸ¥çœ‹ .env æ–‡ä»¶
   cat .env | grep RESEND_API_KEY
   ```
   - ç¡®ä¿ API Key æ­£ç¡®
   - ç¡®ä¿æ²¡æœ‰å¤šä½™çš„ç©ºæ ¼æˆ–å¼•å·

2. **æ£€æŸ¥å‘ä»¶äººé‚®ç®±**
   ```bash
   cat .env | grep EMAIL_FROM
   ```
   - å¼€å‘ç¯å¢ƒå¯ç”¨ `onboarding@resend.dev`
   - ç”Ÿäº§ç¯å¢ƒå¿…é¡»æ˜¯å·²éªŒè¯çš„åŸŸåé‚®ç®±

3. **æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—**
   ```bash
   # æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º
   # åº”è¯¥çœ‹åˆ°ï¼š
   # Email sent successfully: { id: 'xxx', ... }
   
   # å¦‚æœçœ‹åˆ°é”™è¯¯ï¼š
   # Error sending email: { ... }
   ```

4. **æ£€æŸ¥åƒåœ¾é‚®ä»¶ç®±**
   - æŸ¥çœ‹åƒåœ¾é‚®ä»¶/spam æ–‡ä»¶å¤¹
   - å°†å‘ä»¶äººæ·»åŠ åˆ°ç™½åå•

5. **Resend æ§åˆ¶å°æ£€æŸ¥**
   - ç™»å½• [Resend Dashboard](https://resend.com/emails)
   - æŸ¥çœ‹ "Emails" é¡µé¢çš„å‘é€è®°å½•
   - æ£€æŸ¥é‚®ä»¶çŠ¶æ€ï¼ˆdelivered/bounced/failedï¼‰

---

### âŒ é—®é¢˜3: éªŒè¯é“¾æ¥è¿‡æœŸ

**ç—‡çŠ¶**ï¼šç‚¹å‡»éªŒè¯é“¾æ¥æ˜¾ç¤º "é“¾æ¥å·²è¿‡æœŸ"

**åŸå› **ï¼š
- éªŒè¯é“¾æ¥é»˜è®¤ 24 å°æ—¶æœ‰æ•ˆæœŸ
- Token å·²è¢«ä½¿ç”¨æˆ–åˆ é™¤

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **é‡æ–°å‘é€éªŒè¯é‚®ä»¶**
   - å°è¯•ç™»å½•
   - çœ‹åˆ°"é‚®ç®±æœªéªŒè¯"æç¤º
   - ç‚¹å‡»"é‡æ–°å‘é€éªŒè¯é‚®ä»¶"

2. **è°ƒæ•´è¿‡æœŸæ—¶é—´ï¼ˆå¦‚éœ€è¦ï¼‰**
   
   åœ¨ `src/lib/auth.ts` ä¸­ï¼š
   ```typescript
   emailVerification: {
     sendOnSignUp: true,
     expiresIn: 60 * 60 * 24 * 3, // 3å¤©ï¼ˆé»˜è®¤æ˜¯24å°æ—¶ï¼‰
     // ... å…¶ä»–é…ç½®
   }
   ```

---

### âŒ é—®é¢˜4: éªŒè¯æˆåŠŸä½†æ²¡æœ‰è‡ªåŠ¨ç™»å½•

**æ£€æŸ¥é…ç½®**ï¼š

```typescript
// src/lib/auth.ts
emailVerification: {
  sendOnSignUp: true,
  autoSignInAfterVerification: true, // â† ç¡®ä¿ä¸º true
  // ...
}
```

**å¦‚æœä»ä¸å·¥ä½œ**ï¼š
1. æ¸…é™¤æµè§ˆå™¨ cookies
2. æ£€æŸ¥ `BETTER_AUTH_SECRET` æ˜¯å¦æ­£ç¡®é…ç½®
3. é‡å¯æœåŠ¡å™¨

---

### âŒ é—®é¢˜5: å¼€å‘ç¯å¢ƒæµ‹è¯•é—®é¢˜

**Resend å…è´¹ç‰ˆé™åˆ¶**ï¼š
- ä½¿ç”¨ `onboarding@resend.dev` å‘é€
- åªèƒ½å‘é€åˆ°æ³¨å†Œ Resend æ—¶ä½¿ç”¨çš„é‚®ç®±

**è§£å†³æ–¹æ¡ˆ**ï¼š

**é€‰é¡¹ 1ï¼šä½¿ç”¨æ³¨å†Œé‚®ç®±æµ‹è¯•**
```env
EMAIL_FROM=onboarding@resend.dev
```
æ³¨å†Œæ—¶ä½¿ç”¨ä½ åœ¨ Resend æ³¨å†Œçš„é‚®ç®±

**é€‰é¡¹ 2ï¼šéªŒè¯è‡ªå·±çš„åŸŸå**
1. åœ¨ Resend æ·»åŠ åŸŸå
2. é…ç½® DNS è®°å½•
3. éªŒè¯é€šè¿‡åä½¿ç”¨åŸŸåé‚®ç®±

**é€‰é¡¹ 3ï¼šæ§åˆ¶å°è¾“å‡ºï¼ˆè°ƒè¯•ï¼‰**

ä¸´æ—¶æ·»åŠ æ—¥å¿—è¾“å‡ºéªŒè¯é“¾æ¥ï¼š
```typescript
// src/lib/auth.ts
sendVerificationEmail: async ({ user, url }, request) => {
  console.log('ğŸ“§ éªŒè¯é“¾æ¥:', url); // æ·»åŠ è¿™è¡Œ
  await sendEmail({
    to: user.email,
    subject: "éªŒè¯ä½ çš„ Dreamifly é‚®ç®±",
    html: createVerificationEmailHTML(url, user.name),
  });
},
```

ç„¶ååœ¨æ§åˆ¶å°å¤åˆ¶é“¾æ¥ç›´æ¥è®¿é—®ã€‚

---

## å®Œæ•´æ£€æŸ¥æ¸…å•

### ç¯å¢ƒå˜é‡æ£€æŸ¥

```bash
# æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡
cat .env
```

å¿…éœ€çš„å˜é‡ï¼š
- âœ… `DATABASE_URL` - æ•°æ®åº“è¿æ¥
- âœ… `NEXT_PUBLIC_BASE_URL` - åº”ç”¨åŸºç¡€ URL
- âœ… `BETTER_AUTH_SECRET` - è®¤è¯å¯†é’¥
- âœ… `RESEND_API_KEY` - Resend API Key
- âœ… `EMAIL_FROM` - å‘ä»¶äººé‚®ç®±

### ä»£ç é…ç½®æ£€æŸ¥

1. **src/lib/auth.ts**
   - âœ… æ·»åŠ  `baseURL` é…ç½®
   - âœ… `requireEmailVerification: true`
   - âœ… `sendOnSignUp: true`
   - âœ… `autoSignInAfterVerification: true`

2. **src/lib/email.ts**
   - âœ… Resend åˆå§‹åŒ–æ­£ç¡®
   - âœ… `sendEmail` å‡½æ•°æ­£å¸¸å·¥ä½œ

3. **src/app/[locale]/verify-email/page.tsx**
   - âœ… éªŒè¯é¡µé¢å­˜åœ¨
   - âœ… Token å¤„ç†é€»è¾‘æ­£ç¡®

### ç½‘ç»œæ£€æŸ¥

```bash
# æ£€æŸ¥èƒ½å¦è®¿é—® Resend API
curl -X POST https://api.resend.com/emails \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json"
```

### æ•°æ®åº“æ£€æŸ¥

```sql
-- æ£€æŸ¥ verification è¡¨
SELECT * FROM verification ORDER BY created_at DESC LIMIT 5;

-- æ£€æŸ¥ç”¨æˆ·é‚®ç®±éªŒè¯çŠ¶æ€
SELECT id, email, email_verified FROM "user" ORDER BY created_at DESC LIMIT 5;
```

---

## è°ƒè¯•æŠ€å·§

### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—

åœ¨ `src/lib/email.ts` ä¸­æ·»åŠ æ›´å¤šæ—¥å¿—ï¼š

```typescript
export async function sendEmail({ to, subject, html }: SendEmailParams) {
  console.log('ğŸ“§ å‡†å¤‡å‘é€é‚®ä»¶');
  console.log('ğŸ“§ æ”¶ä»¶äºº:', to);
  console.log('ğŸ“§ ä¸»é¢˜:', subject);
  
  try {
    const { data, error } = await resend.emails.send({
      from: process.env.EMAIL_FROM || 'Dreamifly <noreply@dreamifly.com>',
      to: [to],
      subject,
      html,
    });

    if (error) {
      console.error('âŒ é‚®ä»¶å‘é€å¤±è´¥:', error);
      throw new Error('Failed to send email');
    }

    console.log('âœ… é‚®ä»¶å‘é€æˆåŠŸ:', data);
    return data;
  } catch (error) {
    console.error('âŒ å‘é€è¿‡ç¨‹å‡ºé”™:', error);
    throw error;
  }
}
```

### 2. ä¸´æ—¶ç¦ç”¨é‚®ç®±éªŒè¯

å¦‚æœéœ€è¦å¿«é€Ÿæµ‹è¯•å…¶ä»–åŠŸèƒ½ï¼š

```typescript
// src/lib/auth.ts
emailAndPassword: {
  enabled: true,
  requireEmailVerification: false, // ä¸´æ—¶ç¦ç”¨
  autoSignIn: true, // æ³¨å†Œåè‡ªåŠ¨ç™»å½•
}
```

### 3. æŸ¥çœ‹é‚®ä»¶ HTML

ä¿å­˜é‚®ä»¶ HTML åˆ°æ–‡ä»¶æŸ¥çœ‹ï¼š

```typescript
// ä¸´æ—¶ä»£ç 
import fs from 'fs';

const html = createVerificationEmailHTML(url, user.name);
fs.writeFileSync('email-preview.html', html);
```

ç„¶ååœ¨æµè§ˆå™¨æ‰“å¼€ `email-preview.html` æŸ¥çœ‹æ•ˆæœã€‚

---

## æµ‹è¯•æµç¨‹

### å®Œæ•´æµ‹è¯•æ­¥éª¤

1. **å‡†å¤‡å·¥ä½œ**
   ```bash
   # ç¡®ä¿æ‰€æœ‰ç¯å¢ƒå˜é‡æ­£ç¡®
   cat .env
   
   # é‡å¯æœåŠ¡å™¨
   npm run dev
   ```

2. **æ³¨å†Œæµ‹è¯•**
   - æ‰“å¼€æµè§ˆå™¨è®¿é—®ç½‘ç«™
   - ç‚¹å‡»"æ³¨å†Œ"
   - å¡«å†™ä¿¡æ¯ï¼ˆä½¿ç”¨ Resend æ³¨å†Œçš„é‚®ç®±ï¼‰
   - æäº¤æ³¨å†Œ

3. **æ£€æŸ¥é‚®ä»¶**
   - æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
   - æŸ¥çœ‹é‚®ç®±ï¼ˆåŒ…æ‹¬åƒåœ¾é‚®ä»¶ï¼‰
   - æŸ¥çœ‹ Resend æ§åˆ¶å°

4. **éªŒè¯æµ‹è¯•**
   - ç‚¹å‡»é‚®ä»¶ä¸­çš„éªŒè¯é“¾æ¥
   - æ£€æŸ¥æ˜¯å¦è·³è½¬åˆ°éªŒè¯é¡µé¢
   - æ£€æŸ¥æ˜¯å¦æ˜¾ç¤º"éªŒè¯æˆåŠŸ"
   - æ£€æŸ¥æ˜¯å¦è‡ªåŠ¨ç™»å½•

5. **ç™»å½•æµ‹è¯•**
   - ç™»å‡º
   - å°è¯•ç™»å½•
   - åº”è¯¥æˆåŠŸç™»å½•

---

## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### å¿…åšé…ç½®

1. **é…ç½®è‡ªå·±çš„åŸŸåé‚®ç®±**
   ```env
   EMAIL_FROM=noreply@yourdomain.com
   ```

2. **è®¾ç½®æ­£ç¡®çš„ BASE_URL**
   ```env
   NEXT_PUBLIC_BASE_URL=https://yourdomain.com
   ```

3. **ä½¿ç”¨å¼ºå¯†é’¥**
   ```bash
   openssl rand -base64 32
   ```

4. **DNS é…ç½®**
   - SPF è®°å½•
   - DKIM è®°å½•  
   - DMARC è®°å½•

5. **ç›‘æ§è®¾ç½®**
   - é‚®ä»¶å‘é€æˆåŠŸç‡
   - éªŒè¯æˆåŠŸç‡
   - é”™è¯¯å‘Šè­¦

---

## è·å–å¸®åŠ©

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ³•è§£å†³é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ§åˆ¶å°å®Œæ•´é”™è¯¯æ—¥å¿—**
2. **æ£€æŸ¥ Resend æ§åˆ¶å°çš„è¯¦ç»†é”™è¯¯**
3. **æŸ¥çœ‹ Better Auth å®˜æ–¹æ–‡æ¡£**ï¼š
   - [Email Verification](https://www.better-auth.com/docs/authentication/email-password#email-verification)
4. **æ£€æŸ¥é¡¹ç›® Issues**
5. **è”ç³»æŠ€æœ¯æ”¯æŒ**

---

## å¿«é€Ÿä¿®å¤å‘½ä»¤

```bash
# 1. ç¡®ä¿ç¯å¢ƒå˜é‡æ­£ç¡®
cp env.example .env
# ç¼–è¾‘ .env å¡«å…¥æ­£ç¡®çš„å€¼

# 2. é‡æ–°å®‰è£…ä¾èµ–
npm install

# 3. é‡æ–°ç”Ÿæˆæ•°æ®åº“
npx drizzle-kit push

# 4. é‡å¯æœåŠ¡å™¨
npm run dev

# 5. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œ cookies
# åœ¨æµè§ˆå™¨ä¸­æ‰‹åŠ¨æ“ä½œ
```

---

**è®°ä½**ï¼šé‡åˆ°é—®é¢˜æ—¶ï¼Œæœ€é‡è¦çš„æ˜¯æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—å’Œ Resend æ§åˆ¶å°ï¼Œé‚£é‡Œä¼šæœ‰è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼

