# 认证系统使用说明

## 已实现功能

✅ 邮箱密码登录注册
✅ **邮箱验证**（注册后必须验证邮箱才能登录）
✅ 重新发送验证邮件
✅ 用户注册时自动分配默认头像和昵称
✅ 用户登录
✅ 密码重置邮件
✅ 用户资料管理（头像、昵称）
✅ 修改密码
✅ 会话管理
✅ 多语言支持（简体中文、英文、繁体中文）
✅ 精美的HTML邮件模板

## 快速开始

### 1. 数据库迁移

运行以下命令将认证相关的表添加到数据库：

```bash
# 方式一：使用 drizzle-kit
npx drizzle-kit push

# 方式二：使用 better-auth CLI
npx @better-auth/cli migrate
```

### 2. 环境变量

确保你的 `.env` 文件包含以下配置：

```env
DATABASE_URL=你的PostgreSQL连接字符串
NEXT_PUBLIC_BASE_URL=http://localhost:3000  # 或你的生产环境URL
BETTER_AUTH_SECRET=生成一个随机密钥  # 可用命令生成: openssl rand -base64 32

# 邮件服务配置（Resend）
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxxxxxxx  # 从 Resend 获取
EMAIL_FROM=Dreamifly <noreply@yourdomain.com>  # 发件人邮箱
```

**获取 Resend API Key：**
1. 访问 [Resend](https://resend.com/) 注册账号
2. 在控制台创建 API Key
3. 复制 API Key 到 `.env` 文件

详细配置说明请查看 `邮箱验证配置说明.md`

### 3. 启动项目

```bash
npm run dev
```

访问 `http://localhost:3000`，你会在导航栏看到登录按钮。

## 功能说明

### 用户注册

1. 点击导航栏的"登录"按钮
2. 在弹出的模态框中点击"立即注册"
3. 填写昵称、邮箱、密码
4. 点击注册后，系统会发送验证邮件
5. 查看邮箱，点击验证链接
6. 验证成功后自动登录，并分配默认头像

**注意**：
- 注册时只需要输入昵称，不需要输入真实姓名。昵称将作为用户的显示名称。
- 必须验证邮箱后才能登录使用

### 用户登录

1. 点击导航栏的"登录"按钮
2. 输入邮箱和密码
3. 点击"登录"

### 修改个人资料

1. 登录后，点击导航栏的用户头像
2. 选择"个人资料"
3. 在个人资料页面可以：
   - 更换头像（点击"更换头像"按钮上传图片）
   - 修改昵称
   - 修改密码

### 忘记密码

1. 在登录模态框点击"忘记密码？"
2. 输入邮箱地址
3. 点击"发送重置链接"
4. 查看邮箱，点击重置链接
5. 设置新密码

### 重新发送验证邮件

如果没有收到验证邮件：

1. 尝试登录
2. 系统会提示"请先验证邮箱"
3. 点击"重新发送验证邮件"
4. 查看邮箱获取新的验证链接

## 文件结构

```
src/
├── lib/
│   ├── auth.ts              # Better Auth 服务端配置
│   └── auth-client.ts       # Better Auth 客户端
├── app/
│   ├── api/
│   │   └── auth/
│   │       └── [...all]/
│   │           └── route.ts # 认证 API 路由处理器
│   └── [locale]/
│       └── profile/
│           └── page.tsx     # 用户资料页面
├── components/
│   ├── AuthModal.tsx        # 登录/注册模态框
│   └── Navbar.tsx           # 导航栏（已添加认证UI）
└── messages/
    ├── zh.json              # 简体中文翻译
    ├── en.json              # 英文翻译
    └── zh-TW.json           # 繁体中文翻译
```

## 数据库表结构

### user 表（用户表）
- `id`: 用户唯一标识
- `name`: 用户姓名
- `email`: 邮箱（唯一）
- `emailVerified`: 邮箱是否已验证
- `avatar`: 头像URL（默认：`/images/default-avatar.svg`）
- `nickname`: 昵称（可选）
- `createdAt`: 创建时间
- `updatedAt`: 更新时间

### session 表（会话表）
- 存储用户登录会话信息
- 会话有效期：7天
- 包含 IP 地址和用户代理信息

### account 表（账户表）
- 存储认证凭据（加密后的密码）
- 支持多种认证方式

### verification 表（验证表）
- 用于邮箱验证和密码重置

## API 端点

所有认证端点由 Better Auth 自动处理，位于 `/api/auth/*`：

- `POST /api/auth/sign-in/email` - 邮箱密码登录
- `POST /api/auth/sign-up/email` - 邮箱密码注册
- `POST /api/auth/sign-out` - 登出
- `GET /api/auth/session` - 获取当前会话
- `POST /api/auth/update-user` - 更新用户资料
- `POST /api/auth/change-password` - 修改密码
- `POST /api/auth/forget-password` - 请求密码重置
- `POST /api/auth/reset-password` - 使用令牌重置密码

## 在代码中使用

### 客户端组件

```tsx
'use client'
import { useSession, signOut } from '@/lib/auth-client'

function MyComponent() {
  const { data: session, isPending } = useSession()

  if (isPending) return <div>加载中...</div>
  
  if (session?.user) {
    return (
      <div>
        <p>欢迎，{session.user.name}！</p>
        <button onClick={() => signOut()}>退出登录</button>
      </div>
    )
  }

  return <div>未登录</div>
}
```

### 服务端组件

```tsx
import { auth } from '@/lib/auth'
import { headers } from 'next/headers'

export async function GET() {
  const session = await auth.api.getSession({
    headers: await headers()
  })
  
  if (!session) {
    return Response.json({ error: '未授权' }, { status: 401 })
  }
  
  return Response.json({ user: session.user })
}
```

## 安全特性

- ✅ 密码使用 bcrypt 加密
- ✅ 会话令牌唯一且加密安全
- ✅ CSRF 保护
- ✅ 安全的 Cookie 设置
- ✅ 会话自动过期（7天）

## 邮件服务配置

系统使用 Resend 作为邮件服务提供商，已完全集成：

- ✅ 注册验证邮件
- ✅ 密码重置邮件
- ✅ 精美的 HTML 邮件模板
- ✅ 自动发送和重发功能

详细配置请查看 `邮箱验证配置说明.md`

## 待完成功能

1. **头像上传**：需要实现 `/api/upload` 端点来处理头像上传
2. **社交登录**：可以添加 GitHub、Google 等第三方登录
3. **限流保护**：建议添加登录尝试限制以防止暴力破解
4. **双因素认证**：可以添加 2FA 提高安全性

## 自定义配置

### 修改会话有效期

编辑 `src/lib/auth.ts`：

```typescript
session: {
  expiresIn: 60 * 60 * 24 * 30, // 改为 30 天
  updateAge: 60 * 60 * 24, // 1 天
}
```

### 启用邮箱验证

编辑 `src/lib/auth.ts`：

```typescript
emailAndPassword: {
  enabled: true,
  requireEmailVerification: true, // 改为 true
}
```

需要配置邮件发送服务。

### 添加社交登录

编辑 `src/lib/auth.ts`：

```typescript
socialProviders: {
  github: {
    clientId: process.env.GITHUB_CLIENT_ID as string,
    clientSecret: process.env.GITHUB_CLIENT_SECRET as string,
  },
}
```

## 常见问题

### 数据库连接失败
- 检查 `.env` 中的 `DATABASE_URL` 是否正确
- 确保 PostgreSQL 服务正在运行
- 检查网络连接

### 会话丢失
- 清除浏览器 Cookie
- 检查 `BETTER_AUTH_SECRET` 是否已设置
- 确认 `/api/auth/*` 路由可访问

### 头像上传失败
- 确保实现了 `/api/upload` 端点
- 检查文件大小限制（当前为 2MB）
- 确认文件类型为 JPG、PNG 或 GIF

## 技术栈

- **Better Auth**: 现代化的认证库
- **Drizzle ORM**: TypeScript ORM
- **PostgreSQL**: 数据库
- **Next.js 15**: React 框架
- **next-intl**: 国际化支持

## 参考资源

- [Better Auth 官方文档](https://www.better-auth.com/)
- [Better Auth GitHub](https://github.com/better-auth/better-auth)
- [Drizzle ORM 文档](https://orm.drizzle.team/)

## 技术支持

如有问题，请参考：
1. `邮箱验证配置说明.md` - 邮箱验证详细配置
2. `AUTH_SETUP.md` - 详细的英文文档
3. Better Auth 官方文档
4. 项目的 GitHub Issues

