# 认证系统和UID功能测试指南

## 前置条件

1. 确保开发服务器正在运行：
   ```bash
   npm run dev
   ```

2. 确保数据库迁移已完成（avatar字段已添加）

3. 确保环境变量已正确配置（`.env`文件）：
   - `DATABASE_URL`
   - `BETTER_AUTH_SECRET`
   - `NEXT_PUBLIC_BASE_URL`
   - `RESEND_API_KEY`
   - `EMAIL_FROM`

## 测试流程

### 1. 用户注册测试

#### 步骤：
1. 访问 `http://localhost:3000`
2. 点击侧边栏的"登录"按钮
3. 在弹窗中点击"立即注册"切换到注册模式
4. 填写表单：
   - 昵称：随意输入（例如：测试用户）
   - 邮箱：使用真实邮箱
   - 密码：至少8个字符
   - 确认密码：与密码相同
5. 点击"注册"按钮

#### 预期结果：
- ✅ 显示"注册成功！请查看你的邮箱完成验证"
- ✅ 弹窗自动切换到"验证邮箱"模式
- ✅ 显示验证提示信息

#### 验证点：
- 检查服务器控制台是否输出验证链接
- 格式应为：
  ```
  ================================================================================
  📧 邮箱验证邮件
  收件人: your@email.com
  验证链接: https://dreamifly.com/api/auth/verify-email?token=...&callbackURL=/
  提示: 如果QQ邮箱拦截localhost链接，请直接复制上面的链接到浏览器
  ================================================================================
  ```

### 2. UID生成测试

#### 步骤：
1. 注册完成后，检查服务器控制台
2. 或直接查询数据库：
   ```sql
   SELECT id, uid, nickname, email FROM "user" ORDER BY uid DESC LIMIT 5;
   ```

#### 预期结果：
- ✅ 用户的UID已被分配（数字，从1开始递增）
- ✅ 昵称自动设置为 `Dreamer-{uid}`（例如：`Dreamer-1`）
- ✅ avatar字段设置为 `/images/default-avatar.svg`

#### SQL验证：
```sql
-- 查看最新注册的用户
SELECT 
  uid,
  nickname,
  email,
  avatar,
  "emailVerified",
  "createdAt"
FROM "user"
ORDER BY "createdAt" DESC
LIMIT 1;
```

预期输出示例：
```
 uid | nickname  |      email       |           avatar            | emailVerified |     createdAt
-----+-----------+------------------+-----------------------------+---------------+-------------------
   5 | Dreamer-5 | test5@example.com| /images/default-avatar.svg |     false     | 2024-01-15 10:30
```

### 3. 邮箱验证测试

#### 步骤：
1. 检查注册邮箱
2. 如果使用QQ邮箱且链接被拦截：
   - 从服务器控制台复制完整的验证链接
   - 粘贴到浏览器地址栏
3. 如果是其他邮箱服务商：
   - 直接点击邮件中的验证按钮

#### 预期结果：
- ✅ 浏览器重定向到验证成功页面
- ✅ 显示"Email Verified!"消息
- ✅ 3秒后自动跳转到首页
- ✅ 用户自动登录

#### 验证点：
数据库中用户的 `emailVerified` 字段应变为 `true`：
```sql
SELECT email, "emailVerified" FROM "user" WHERE email = 'your@email.com';
```

### 4. 登录测试

#### 步骤：
1. 如果未自动登录，点击"登录"按钮
2. 输入邮箱和密码
3. 点击"登录"

#### 预期结果：
- ✅ 登录成功，显示"登录成功！"
- ✅ 侧边栏显示用户头像和昵称（`Dreamer-{uid}`）
- ✅ 顶部栏（移动端）也显示用户头像

### 5. 个人资料页面测试

#### 步骤：
1. 登录后，点击侧边栏的用户头像
2. 在下拉菜单中点击"个人资料"
3. 查看个人资料页面

#### 预期结果：
- ✅ 显示用户的UID（格式：`#1`、`#2`等）
- ✅ UID字段为只读，灰色背景
- ✅ 显示默认头像
- ✅ 显示邮箱（只读）
- ✅ 显示昵称（默认为 `Dreamer-{uid}`）
- ✅ 昵称可编辑

### 6. 修改昵称测试

#### 步骤：
1. 在个人资料页面，修改昵称为其他内容
2. 点击"保存更改"按钮

#### 预期结果：
- ✅ 显示"个人资料更新成功！"
- ✅ 页面自动刷新
- ✅ 侧边栏显示新的昵称
- ✅ UID保持不变

#### 验证点：
```sql
SELECT uid, nickname FROM "user" WHERE email = 'your@email.com';
```

### 7. 修改头像测试

#### 步骤：
1. 在个人资料页面，点击"更换头像"按钮
2. 选择一个图片文件（JPG/PNG/GIF，小于2MB）
3. 等待上传完成
4. 点击"保存更改"

#### 预期结果：
- ✅ 上传过程中显示加载动画
- ✅ 上传成功后头像预览更新
- ✅ 保存后侧边栏头像更新

#### 注意事项：
- 确保 `/api/upload` 路由已实现
- 确保上传目录存在且有写权限

### 8. 修改密码测试

#### 步骤：
1. 在个人资料页面，点击"修改密码"展开表单
2. 输入：
   - 当前密码
   - 新密码（至少8个字符）
   - 确认新密码
3. 点击"修改密码"按钮

#### 预期结果：
- ✅ 显示"密码修改成功！"
- ✅ 表单自动折叠并清空
- ✅ 可以使用新密码重新登录

### 9. 登出测试

#### 步骤：
1. 点击用户头像
2. 在下拉菜单中点击"登出"

#### 预期结果：
- ✅ 用户成功登出
- ✅ 侧边栏恢复显示"登录"按钮
- ✅ 无法访问个人资料页面（自动重定向）

### 10. 密码重置测试

#### 步骤：
1. 在登录弹窗，点击"忘记密码？"
2. 输入注册邮箱
3. 点击"发送重置链接"
4. 检查邮箱或服务器控制台
5. 访问重置链接

#### 预期结果：
- ✅ 显示"重置链接已发送到你的邮箱"
- ✅ 收到密码重置邮件
- ✅ 点击链接后可以设置新密码

## 常见问题排查

### 1. QQ邮箱链接被拦截

**现象：** 点击验证链接显示 "Invalid url" 错误

**解决方案：**
1. 从服务器控制台复制完整的验证URL
2. 手动粘贴到浏览器地址栏访问
3. 或使用其他邮箱服务商（Gmail、Outlook等）

### 2. UID未生成

**现象：** 注册后UID为空

**排查步骤：**
1. 检查服务器控制台是否有错误
2. 确认 `/api/auth/signup-handler` 被正确调用
3. 检查数据库连接
4. 手动运行SQL查看最大UID：
   ```sql
   SELECT MAX(uid) FROM "user";
   ```

### 3. 头像上传失败

**可能原因：**
- 上传目录不存在
- 文件权限问题
- 文件大小超过限制
- 文件类型不支持

**排查步骤：**
1. 检查 `public/uploads` 目录是否存在
2. 检查服务器日志
3. 确认 `/api/upload` 路由实现正确

### 4. 邮件未收到

**可能原因：**
- Resend API Key错误
- EMAIL_FROM配置错误
- 域名未在Resend验证
- 邮件被垃圾邮件过滤

**排查步骤：**
1. 检查 `.env` 文件配置
2. 查看服务器控制台的邮件发送日志
3. 检查Resend后台日志
4. 检查邮箱垃圾邮件文件夹

## 数据库检查命令

### 查看所有用户
```sql
SELECT uid, nickname, email, "emailVerified", "createdAt" 
FROM "user" 
ORDER BY uid;
```

### 查看最新5个用户
```sql
SELECT uid, nickname, email, avatar 
FROM "user" 
ORDER BY "createdAt" DESC 
LIMIT 5;
```

### 查看UID分配情况
```sql
SELECT 
  COUNT(*) as total_users,
  COUNT(uid) as users_with_uid,
  MAX(uid) as max_uid,
  MIN(uid) as min_uid
FROM "user";
```

### 检查是否有重复UID
```sql
SELECT uid, COUNT(*) as count 
FROM "user" 
WHERE uid IS NOT NULL
GROUP BY uid 
HAVING COUNT(*) > 1;
```

## 性能测试

### 批量注册测试
建议使用脚本进行批量注册测试，验证：
1. UID生成的唯一性
2. 昵称设置的正确性
3. 并发注册时的数据一致性

## 安全测试

### 1. SQL注入测试
尝试在输入字段中注入SQL代码，确保被正确过滤。

### 2. XSS测试
尝试在昵称中输入脚本代码，确保被正确转义。

### 3. 密码强度测试
尝试注册弱密码，确保被拒绝（小于8个字符）。

## 测试完成检查清单

- [ ] 用户注册成功
- [ ] UID自动生成并唯一
- [ ] 默认昵称为 `Dreamer-{uid}`
- [ ] 邮箱验证成功
- [ ] 用户可以登录
- [ ] 个人资料页面正确显示UID
- [ ] 可以修改昵称
- [ ] 可以修改头像
- [ ] 可以修改密码
- [ ] 可以登出
- [ ] 可以重置密码
- [ ] QQ邮箱问题有备用方案
- [ ] 数据库中数据完整
- [ ] 无SQL注入漏洞
- [ ] 无XSS漏洞

## 报告问题

如果测试中发现问题，请提供：
1. 问题描述
2. 重现步骤
3. 预期行为
4. 实际行为
5. 服务器控制台日志
6. 浏览器控制台错误
7. 相关截图

