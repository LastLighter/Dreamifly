# 邮箱验证配置说明

## 概述

系统已集成 Resend 邮件服务，实现完整的邮箱验证功能。用户注册后必须验证邮箱才能登录。

## 环境变量配置

在 `.env` 文件中添加以下配置：

```env
# Resend API 密钥（必需）
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxxxxxxxxxx

# 发件人邮箱（必需）
EMAIL_FROM=Dreamifly <noreply@yourdomain.com>

# 其他现有配置
DATABASE_URL=your_postgresql_connection_string
NEXT_PUBLIC_BASE_URL=http://localhost:3000
BETTER_AUTH_SECRET=your_secret_key
```

### 获取 Resend API Key

1. 访问 [Resend 官网](https://resend.com/)
2. 注册账号并登录
3. 进入 **API Keys** 页面
4. 点击 **Create API Key**
5. 复制生成的 API Key 到 `.env` 文件

### 配置发件人邮箱

1. 在 Resend 控制台，进入 **Domains** 页面
2. 添加你的域名（如 `yourdomain.com`）
3. 按照提示配置 DNS 记录（SPF, DKIM, DMARC）
4. 验证域名
5. 使用验证后的域名作为发件人邮箱

**开发环境提示**：
- Resend 免费版可使用 onboarding 邮箱（如 `onboarding@resend.dev`）
- 但只能发送到你注册 Resend 时使用的邮箱
- 生产环境必须配置自己的域名

## 功能说明

### 1. 用户注册流程

```
用户填写注册信息 → 提交注册 → 创建账号（未验证状态） 
→ 自动发送验证邮件 → 显示"请查看邮箱"提示
```

### 2. 邮箱验证流程

```
用户收到邮件 → 点击验证链接 → 跳转验证页面 
→ 自动验证 → 验证成功 → 自动登录并跳转首页
```

### 3. 登录限制

```
未验证邮箱的用户登录 → 显示"请先验证邮箱"错误 
→ 提供重新发送验证邮件按钮
```

## 文件结构

```
src/
├── lib/
│   ├── email.ts                 # 邮件服务（Resend集成）
│   ├── auth.ts                  # 邮箱验证配置
│   └── auth-client.ts           # 客户端方法
├── app/
│   └── [locale]/
│       └── verify-email/
│           └── page.tsx         # 邮箱验证页面
├── components/
│   └── AuthModal.tsx            # 注册/登录模态框（含验证提示）
└── messages/
    ├── zh.json                  # 中文翻译
    ├── en.json                  # 英文翻译
    └── zh-TW.json               # 繁体中文翻译
```

## 邮件模板

系统提供两种精美的 HTML 邮件模板：

### 1. 邮箱验证邮件

- **标题**：验证你的 Dreamifly 邮箱
- **内容**：包含验证链接按钮和备用链接
- **有效期**：24 小时
- **模板函数**：`createVerificationEmailHTML()`

### 2. 密码重置邮件

- **标题**：重置你的 Dreamifly 密码
- **内容**：包含重置密码链接
- **有效期**：1 小时
- **模板函数**：`createPasswordResetEmailHTML()`

## 用户体验

### 注册成功页面

用户注册后会看到：

```
✅ 注册成功！请查看邮箱完成验证

📧 查看你的邮箱
我们已向以下地址发送验证邮件：user@example.com
请点击邮件中的链接完成验证。

[重新发送验证邮件]
[返回登录]
```

### 验证成功页面

点击邮件链接后：

```
✅ 验证成功！

邮箱验证成功！
即将跳转到首页...

（3秒后自动跳转）
```

### 登录限制提示

未验证用户尝试登录：

```
❌ 请先验证你的邮箱地址

[重新发送验证邮件]
```

## API 端点

Better Auth 自动提供以下端点：

- `POST /api/auth/sign-up/email` - 注册（自动发送验证邮件）
- `POST /api/auth/verify-email` - 验证邮箱
- `POST /api/auth/send-verification-email` - 重新发送验证邮件
- `POST /api/auth/sign-in/email` - 登录（需要已验证）
- `POST /api/auth/forget-password` - 请求密码重置
- `POST /api/auth/reset-password` - 重置密码

## 开发测试

### 测试注册流程

1. 启动开发服务器：`npm run dev`
2. 访问网站并点击"注册"
3. 填写信息并提交
4. 查看控制台输出的验证链接（或检查邮箱）
5. 点击验证链接
6. 验证成功后自动登录

### 测试重发验证邮件

1. 尝试用未验证的账号登录
2. 看到"请先验证邮箱"提示
3. 点击"重新发送验证邮件"
4. 检查邮箱获取新的验证链接

## 常见问题

### Q: 为什么收不到验证邮件？

**A:** 检查以下几点：
1. ✅ `RESEND_API_KEY` 是否正确配置
2. ✅ `EMAIL_FROM` 邮箱是否已验证
3. ✅ 检查邮箱的垃圾邮件文件夹
4. ✅ 确认 Resend 账号额度未用完
5. ✅ 开发环境需使用 onboarding 邮箱发送到注册邮箱

### Q: 验证链接过期了怎么办？

**A:** 用户可以：
1. 尝试登录
2. 看到"邮箱未验证"提示
3. 点击"重新发送验证邮件"
4. 获取新的验证链接

### Q: 如何更改邮件模板？

**A:** 编辑 `src/lib/email.ts` 中的：
- `createVerificationEmailHTML()` - 验证邮件模板
- `createPasswordResetEmailHTML()` - 密码重置邮件模板

### Q: 如何关闭邮箱验证要求？

**A:** 编辑 `src/lib/auth.ts`：

```typescript
emailAndPassword: {
  enabled: true,
  requireEmailVerification: false, // 改为 false
  autoSignIn: true, // 改为 true（注册后自动登录）
}
```

### Q: 生产环境如何配置？

**A:** 
1. 在 Resend 添加并验证自己的域名
2. 配置 DNS 记录（SPF, DKIM, DMARC）
3. 更新 `.env` 中的 `EMAIL_FROM` 为自己的域名邮箱
4. 确保 `NEXT_PUBLIC_BASE_URL` 是生产环境 URL
5. 生产环境不要使用 onboarding 邮箱

## 安全特性

- ✅ 验证链接带有加密 token
- ✅ 验证链接有时效性（24小时）
- ✅ 未验证用户无法登录
- ✅ 可重新发送验证邮件（防止邮件丢失）
- ✅ 验证后自动登录（提升用户体验）
- ✅ 邮件内容使用 HTTPS 链接

## 监控和日志

邮件发送日志会输出到控制台：

```javascript
// 成功
Email sent successfully: { id: 'xxx', ... }

// 失败
Error sending email: { error: '...' }
```

建议生产环境：
- 使用专业日志服务（如 Sentry）
- 监控邮件发送成功率
- 设置发送失败告警

## 成本说明

### Resend 免费版

- ✅ 每月 3,000 封邮件
- ✅ 每天 100 封邮件
- ✅ 1 个域名
- ✅ API 访问
- ❌ 仅可发送到注册邮箱（onboarding）

### Resend 付费版

从 $20/月起：
- ✅ 每月 50,000 封邮件
- ✅ 无限域名
- ✅ 更高发送速率
- ✅ 优先支持

**建议**：
- 开发/测试：免费版足够
- 生产环境（小规模）：免费版足够
- 生产环境（大规模）：考虑付费版

## 下一步

完成邮箱验证配置后，你可以：

1. ✅ 测试完整的注册验证流程
2. ✅ 自定义邮件模板样式
3. ✅ 添加邮件统计和监控
4. ✅ 考虑添加欢迎邮件
5. ✅ 实现密码重置功能
6. ✅ 配置邮件队列（高并发场景）

## 参考资源

- [Resend 官方文档](https://resend.com/docs)
- [Better Auth 邮箱验证文档](https://www.better-auth.com/docs/authentication/email-password#email-verification)
- [Better Auth GitHub](https://github.com/better-auth/better-auth)

## 技术支持

如遇问题：
1. 查看控制台日志
2. 检查 Resend 控制台的发送记录
3. 参考 Better Auth 官方文档
4. 检查环境变量配置

