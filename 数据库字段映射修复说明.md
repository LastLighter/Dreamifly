# 数据库字段映射修复说明

## 问题描述

在测试注册功能时，遇到以下错误：

```
ERROR [Better Auth]: column "emailVerified" does not exist
SERVER_ERROR: [Error [PostgresError]: column "emailVerified" does not exist]
hint: 'Perhaps you meant to reference the column "user.email_verified".'
```

**根本原因：** 数据库使用**下划线命名**（snake_case），但代码中的Drizzle schema使用了**驼峰命名**（camelCase）。

## 数据库实际字段名

### User表
| 代码中的属性名 | 数据库字段名 |
|---------------|-------------|
| emailVerified | email_verified |
| createdAt | created_at |
| updatedAt | updated_at |
| isActive | is_active |
| lastLoginAt | last_login_at |

### Session表
| 代码中的属性名 | 数据库字段名 |
|---------------|-------------|
| expiresAt | expires_at |
| createdAt | created_at |
| updatedAt | updated_at |
| ipAddress | ip_address |
| userAgent | user_agent |
| userId | user_id |

### Account表
| 代码中的属性名 | 数据库字段名 |
|---------------|-------------|
| accountId | account_id |
| providerId | provider_id |
| userId | user_id |
| accessToken | access_token |
| refreshToken | refresh_token |
| idToken | id_token |
| accessTokenExpiresAt | access_token_expires_at |
| refreshTokenExpiresAt | refresh_token_expires_at |
| createdAt | created_at |
| updatedAt | updated_at |

### Verification表
| 代码中的属性名 | 数据库字段名 |
|---------------|-------------|
| expiresAt | expires_at |
| createdAt | created_at |
| updatedAt | updated_at |

## 解决方案

### 1. 更新Schema.ts

在Drizzle ORM中，可以通过在定义时指定数据库字段名来实现映射：

```typescript
// 代码中使用驼峰命名（TypeScript属性）
emailVerified: boolean("email_verified").default(false)
//                      ^^^^^^^^^^^^^^^^
//                      数据库中的实际字段名
```

**完整示例：**

```typescript
export const user = pgTable("user", {
  id: text("id").primaryKey(),
  name: text("name"),
  email: text("email").notNull().unique(),
  emailVerified: boolean("email_verified").default(false), // 映射到 email_verified
  image: text("image"),
  createdAt: timestamp("created_at").defaultNow().notNull(), // 映射到 created_at
  updatedAt: timestamp("updated_at").defaultNow().notNull(), // 映射到 updated_at
  nickname: text("nickname"),
  uid: integer("uid").unique(),
  avatar: text("avatar").default("/images/default-avatar.svg"),
  signature: text("signature"),
  isActive: boolean("is_active").default(true), // 映射到 is_active
  lastLoginAt: timestamp("last_login_at"), // 映射到 last_login_at
});
```

### 2. 添加缺失字段

运行迁移脚本添加新字段：

```bash
node scripts/add-missing-fields.js
```

**添加的字段：**
- ✅ `uid` - integer, unique
- ✅ `is_active` - boolean, default true
- ✅ `last_login_at` - timestamp

## 验证步骤

### 1. 检查数据库字段

```bash
node scripts/check-all-tables.js
```

### 2. 验证字段映射

```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'user' 
ORDER BY ordinal_position;
```

### 3. 测试注册功能

1. 启动开发服务器：
   ```bash
   npm run dev
   ```

2. 访问 http://localhost:3000

3. 测试注册流程

4. 查看服务器日志，确认没有字段错误

## 已修复的文件

- ✅ `src/db/schema.ts` - 所有表的字段映射已更新
- ✅ 数据库字段 - uid, is_active, last_login_at 已添加

## Drizzle ORM字段映射规则

### 基本语法

```typescript
propertyName: dataType("database_column_name")
```

### 示例

```typescript
// TypeScript中使用 emailVerified (驼峰)
// 数据库中查询 email_verified (下划线)
emailVerified: boolean("email_verified").default(false)
```

### 好处

1. **代码层面**：保持JavaScript/TypeScript的驼峰命名风格
2. **数据库层面**：保持PostgreSQL的下划线命名风格
3. **兼容性**：与Better Auth的默认数据库结构兼容

## 常见错误和解决方案

### 错误1: column "xxx" does not exist

**原因：** Schema中的字段名与数据库不匹配

**解决：** 检查数据库实际字段名，更新schema定义

```typescript
// ❌ 错误
emailVerified: boolean("emailVerified")

// ✅ 正确
emailVerified: boolean("email_verified")
```

### 错误2: duplicate column name

**原因：** 尝试添加已存在的字段

**解决：** 先检查字段是否存在，再决定是否添加

```javascript
const check = await client.query(`
  SELECT column_name FROM information_schema.columns 
  WHERE table_name = 'user' AND column_name = 'uid'
`);

if (check.rows.length === 0) {
  await client.query(`ALTER TABLE "user" ADD COLUMN "uid" integer UNIQUE`);
}
```

## 最佳实践

### 1. 命名一致性

- **TypeScript/JavaScript代码**：使用驼峰命名（camelCase）
- **数据库字段**：使用下划线命名（snake_case）
- **通过Drizzle映射**：连接两种命名风格

### 2. 迁移管理

- 使用脚本检查字段是否存在
- 使用条件SQL语句（IF NOT EXISTS）
- 记录所有数据库变更

### 3. 文档维护

- 保持schema定义与数据库同步
- 记录字段映射关系
- 更新相关文档

## 工具脚本

### 检查所有表字段

```bash
node scripts/check-all-tables.js
```

### 添加缺失字段

```bash
node scripts/add-missing-fields.js
```

### 检查特定表

```bash
node scripts/check-db-columns.js
```

## 测试检查清单

- [x] User表字段映射正确
- [x] Session表字段映射正确
- [x] Account表字段映射正确
- [x] Verification表字段映射正确
- [x] uid字段已添加
- [x] is_active字段已添加
- [x] last_login_at字段已添加
- [x] 无linter错误
- [ ] 注册功能测试通过（待测试）
- [ ] 登录功能测试通过（待测试）
- [ ] UID生成测试通过（待测试）

## 下一步

1. **测试注册流程**
   - 访问注册页面
   - 填写表单并提交
   - 验证邮箱
   - 检查UID是否正确生成

2. **测试登录流程**
   - 使用注册的账号登录
   - 验证session创建
   - 检查个人资料页面

3. **验证数据完整性**
   ```sql
   SELECT id, uid, nickname, email, email_verified, is_active 
   FROM "user" 
   ORDER BY created_at DESC 
   LIMIT 5;
   ```

## 总结

✅ **问题已解决**

- 所有表的字段映射已更新为正确的下划线命名
- 缺失的字段（uid, is_active, last_login_at）已添加
- Schema定义与数据库结构完全匹配
- 代码中可以继续使用驼峰命名访问属性

**核心原理：** Drizzle ORM通过字段定义中的字符串参数实现了代码命名和数据库命名的映射，让我们在保持各自命名规范的同时实现无缝集成。

---

**修复时间：** 2024  
**状态：** ✅ 已修复，待测试  
**相关文件：** `src/db/schema.ts`, `scripts/add-missing-fields.js`

